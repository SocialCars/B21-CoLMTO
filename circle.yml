general:
    branches:
        only:
            - master
        ignore:
            - develop
            - /dev-.*/
            - /gh-.*/
            - /sim-.*/

machine:
    timezone:
        Europe/Berlin

    environment:
        GIT_AUTHOR_NAME: CircleCI
        GIT_AUTHOR_EMAIL: masc@tu-clausthal.de
        GIT_COMMITTER_NAME: CircleCI
        GIT_COMMITTER_EMAIL: masc@tu-clausthal.de
        SUMO_HOME: /usr/share/sumo
        TEXINSTALL: minimal
        DOCUMENT: OpTOM-doc
        PATH: $PATH:/tmp/texlive/bin/x86_64-linux
    python:
        version: 2.7.12

dependencies:
    cache_directories:
        - "/tmp/texlive/"
        
    pre:
        - sudo add-apt-repository -y ppa:sumo/stable
        - sudo apt-get update
        - sudo apt-get install doxygen graphviz sumo libhdf5-dev pandoc tk-dev python-tk
        - pip install pylint radon codecov doxypy
        - if [ ! -d /tmp/texlive/ ]; then curl -L https://tesseract.in.tu-clausthal.de:8443/index.php/s/3ZKzReAc69yBNou/download | sudo tar xJp --strip 2 -C /tmp; fi
        - sudo tlmgr update --self --all --reinstall-forcibly-removed

checkout:
  post:
    - git submodule sync
    - git submodule update --init

test:
    post:
        - git checkout master
        - python setup.py install
        - python setup.py test
        - SUMO_HOME=/usr/share/sumo python -m run --fresh-configs --scenarios NI-B210 --runs 1
        - SUMO_HOME=/usr/share/sumo python -m run --fresh-configs --cse --scenarios NI-B210 --runs 1
        # codecov
        - nosetests -w tests --with-coverage
        - bash <(curl -s https://codecov.io/bash) -t 910321f1-7584-4bc8-b264-bce881241d83
        - mv -f optom tests site run.py README.md LICENSE.md /tmp
        - git checkout gh-pages
        - mv -f circle.yml .gitignore /tmp
        - git checkout master
        - git push origin :gh-pages
        - git branch -D gh-pages
        - git checkout --orphan gh-pages
        - rm -Rf *
        - rm .pre-commit-config.yaml
        - mv -f /tmp/.gitignore /tmp/circle.yml /tmp/optom /tmp/tests /tmp/run.py /tmp/site /tmp/README.md /tmp/LICENSE.md .
        - pylint optom tests run.py -f html --import-graph=optom-imports.png > pylint.html; true
        - pandoc --from html --to markdown_github pylint.html -o pylint.md
        - echo -e "\n## Import Graph\n" >> pylint.md
        - cp pylint.md pylint_doc.md
        - echo -e "\n![ImportGraph](https://github.com/masc/optom/blob/gh-pages/docs/sources/optom-imports.png)" >> pylint.md
        - echo -e "\n# Code Statistics\n\n" > REPORT.md
        - echo -e "## Copyright & License\n\n- Copyright 2017, Malte Aschermann\n- License LGPL\n\n" > README_doc.md
        - sh site/radon.sh > radon.md
        - cat radon.md >> REPORT.md
        - echo -e "\n# Pylint\n\n" >> REPORT.md
        - cat pylint.md >> REPORT.md
        - doxygen site/configuration.doxyfile
        # build latex
        - cd docs/latex/ && make && cd ..
        - mv docs/latex/refman.pdf docs/$DOCUMENT.pdf
        - rm -Rf docs/latex
        - mv optom-imports.png docs/sources
        - rm -Rf optom tests site run.py README_doc.md pylint.html pylint.md pylint_doc.md radon.md
        # add & commit
        - git add --all .
        - git commit -m "CircleCI run complete. Report https://github.com/masc/optom/blob/gh-pages/REPORT.md , Doku http://masc.github.io/optom/docs/sources/index.html"
        - git push origin gh-pages
