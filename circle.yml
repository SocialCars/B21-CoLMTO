general:
    branches:
        only:
            - master
        ignore:
            - develop
            - /dev-.*/
            - /gh-.*/
            - /sim-.*/

machine:
    timezone:
        Europe/Berlin

    environment:
        GIT_AUTHOR_NAME: CircleCI
        GIT_AUTHOR_EMAIL: masc@tu-clausthal.de
        GIT_COMMITTER_NAME: CircleCI
        GIT_COMMITTER_EMAIL: masc@tu-clausthal.de
        SUMO_HOME: /usr/share/sumo

    python:
        version: 2.7.12

dependencies:
    pre:
        - sudo add-apt-repository -y ppa:sumo/stable
        - sudo apt-get update
        - sudo apt-get install sumo sumo-tools sumo-doc
        - sudo apt-get install libhdf5-dev pandoc graphviz tk-dev python-tk
        - pip install pylint
        - pip install radon

checkout:
  post:
    - git submodule sync
    - git submodule update --init

test:
    post:
        - git checkout master
        - python setup.py install
        - SUMO_HOME=/usr/share/sumo python -m run
        - bash <(curl -s https://codecov.io/bash) -t 910321f1-7584-4bc8-b264-bce881241d83
        - mv -f optom /tmp
        - mv -f tests /tmp
        - mv -f run.py /tmp
        - git checkout gh-pages
        - mv -f circle.yml /tmp
        - mv -f .gitignore /tmp
        - mv -f radon.sh /tmp
        - git checkout master
        - git push origin :gh-pages
        - git branch -D gh-pages
        - git checkout --orphan gh-pages
        - rm -Rf *
        - rm .pre-commit-config.yaml
        - mv -f /tmp/.gitignore .
        - mv -f /tmp/circle.yml .
        - mv -f /tmp/radon.sh .
        - mv -f /tmp/optom .
        - mv -f /tmp/tests .
        - mv -f /tmp/run.py .
        - pylint optom tests run.py -f html --import-graph=optom-imports.png > pylint.html; true
        - pandoc --from html --to markdown_github pylint.html -o pylint.md
        - echo -e "\n## Import Graph" >> pylint.md
        - echo -e "\n![ImportGraph](https://github.com/masc/optom/blob/gh-pages/optom-imports.png)" >> pylint.md
        - echo -e "# OPTOM Statistics\n\n" > README.md
        - echo -e '[![CircleCI](https://circleci.com/gh/masc/optom/tree/master.svg?style=shield&circle-token=ff9f6072df84edef937bff818eb00102157245b4)](https://circleci.com/gh/masc/optom/tree/master)\n\n' >> README.md
        - sh radon.sh > radon.md
        - rm -Rf optom
        - cat radon.md >> README.md
        - echo -e "\n# Pylint\n" >> README.md
        - cat pylint.md >> README.md
        - git add --all .
        - git commit -m "CircleCI run complete. Report available at https://github.com/masc/optom/blob/gh-pages/README.md"
        - git push origin gh-pages
