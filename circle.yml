general:
    branches:
        only:
            - master
        ignore:
            - develop
            - /dev-.*/
            - /gh-.*/
            - /sim-.*/

machine:
    timezone:
        Europe/Berlin

    environment:
        GIT_AUTHOR_NAME: CircleCI
        GIT_AUTHOR_EMAIL: masc@tu-clausthal.de
        GIT_COMMITTER_NAME: CircleCI
        GIT_COMMITTER_EMAIL: masc@tu-clausthal.de
        SUMO_HOME: /usr/share/sumo
        TEXINSTALL: minimal
        DOCUMENT: CoLMTO-doc
        PATH: $PATH:/tmp/texlive/bin/x86_64-linux
    python:
        version: 3.6.1

dependencies:
    cache_directories:
        - "/tmp/texlive/"

    pre:
        - sudo add-apt-repository -y ppa:sumo/stable
        - sudo apt-get update
        - sudo apt-get install doxygen graphviz sumo libhdf5-dev pandoc tk-dev python-tk
        - pip3 install pylint radon codecov doxypy
        - if [ ! -d /tmp/texlive/ ]; then curl -L https://tesseract.in.tu-clausthal.de:8443/index.php/s/3ZKzReAc69yBNou/download | sudo tar xJp --strip 2 -C /tmp; fi
        - sudo /tmp/texlive/bin/x86_64-linux/tlmgr update --self --all --reinstall-forcibly-removed

checkout:
  post:
    - git submodule sync
    - git submodule update --init

test:
    post:
        - git checkout master
        - python3 setup.py install
        - python3 setup.py test
        - SUMO_HOME=/usr/share/sumo python3 -m colmto --fresh-configs --scenarios NI-B210 --runs 1
        - SUMO_HOME=/usr/share/sumo python3 -m colmto --fresh-configs --cse --scenarios NI-B210 --runs 1
        # codecov
        - nosetests -w tests --with-coverage
        - bash <(curl -s https://codecov.io/bash) -t 910321f1-7584-4bc8-b264-bce881241d83
        - bash <(curl -s https://codecov.io/bash) -t 06655147-fb7f-41be-9b5f-45c85c4f591f
        - mv -f colmto tests site readme.md license.md architecture.png /tmp
        - git checkout gh-pages
        - mv -f circle.yml .gitignore /tmp
        - git checkout master
        - git push origin :gh-pages || true
        - git branch -D gh-pages
        - git checkout --orphan gh-pages
        - rm -Rf *
        - rm .pre-commit-config.yaml
        - mv -f /tmp/.gitignore /tmp/circle.yml /tmp/colmto /tmp/tests /tmp/site /tmp/readme.md /tmp/license.md /tmp/architecture.png .
        - sh site/pylint.sh > pylint.md || true
        - echo -e "\n## Import Graph\n" >> pylint.md
        - cp pylint.md pylint_doc.md
        - echo -e "\n![ImportGraph](https://github.com/SocialCars/colmto/blob/gh-pages/docs/sources/colmto-imports.png)" >> pylint.md
        - echo -e "\n# Code Statistics\n\n" > report.md
        - echo -e "## Copyright & License\n\n- Copyright 2017, Malte Aschermann\n- License LGPL\n\n" > readme_doc.md
        - sh site/radon.sh > radon.md
        - cat radon.md >> report.md
        - echo -e "\n# Pylint\n\n" >> report.md
        - cat pylint.md >> report.md
        - doxygen site/configuration.doxyfile
        # build latex
        - cd docs/latex/ && make && cd ..
        - mv docs/latex/refman.pdf docs/$DOCUMENT.pdf
        - rm -Rf docs/latex
        - mv colmto-imports.png docs/sources
        - rm -Rf colmto tests site readme_doc.md pylint.html pylint.md pylint_doc.md radon.md
        # add & commit
        - git add --all .
        - git commit -m "CircleCI run complete. Report https://github.com/SocialCars/colmto/blob/gh-pages/report.md , Doku http://socialcars.github.io/colmto/docs/sources/index.html"
        - git push origin gh-pages
