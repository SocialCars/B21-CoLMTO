general:
    branches:
        only:
            - master
        ignore:
            - develop
            - /dev-.*/
            - /gh-.*/
            - /sim-.*/

machine:
    timezone:
        Europe/Berlin

    environment:
        GIT_AUTHOR_NAME: CircleCI
        GIT_AUTHOR_EMAIL: masc@tu-clausthal.de
        GIT_COMMITTER_NAME: CircleCI
        GIT_COMMITTER_EMAIL: masc@tu-clausthal.de
        SUMO_HOME: /usr/share/sumo

    python:
        version: 2.7.12

dependencies:
    pre:
        - sudo add-apt-repository -y ppa:sumo/stable
        - sudo apt-get update
        - sudo apt-get install doxygen graphviz
        - sudo apt-get install sumo sumo-tools sumo-doc
        - sudo apt-get install libhdf5-dev pandoc tk-dev python-tk
        - pip install pylint
        - pip install radon
        - pip install codecov

checkout:
  post:
    - git submodule sync
    - git submodule update --init

test:
    post:
        - git checkout master
        - codecov --token=910321f1-7584-4bc8-b264-bce881241d83
        - bash <(curl -s https://codecov.io/bash) -t 910321f1-7584-4bc8-b264-bce881241d83
        - python setup.py install
        - SUMO_HOME=/usr/share/sumo python -m run
        - mv -f optom /tmp
        - mv -f tests /tmp
        - mv -f site /tmp
        - mv -f run.py /tmp
        - mv -f README.md /tmp
        - mv -f LICENSE.md /tmp
        - git checkout gh-pages
        - mv -f circle.yml /tmp
        - mv -f .gitignore /tmp
        - git checkout master
        - git push origin :gh-pages
        - git branch -D gh-pages
        - git checkout --orphan gh-pages
        - rm -Rf *
        - rm .pre-commit-config.yaml
        - mv -f /tmp/.gitignore .
        - mv -f /tmp/circle.yml .
        - mv -f /tmp/optom .
        - mv -f /tmp/tests .
        - mv -f /tmp/run.py .
        - mv -f /tmp/site .
        - mv -f /tmp/README.md .
        - mv -f /tmp/LICENSE.md .
        - pylint optom tests run.py -f html --import-graph=optom-imports.png > pylint.html; true
        - pandoc --from html --to markdown_github pylint.html -o pylint.md
        - echo -e "\n## Import Graph\n" >> pylint.md
        - cp pylint.md pylint_doc.md
        - echo -e "\n![ImportGraph](https://github.com/masc/optom/blob/gh-pages/optom-imports.png)" >> pylint.md
        - echo -e "\n![ImportGraph](optom-imports.png)" >> pylint_doc.md
        - echo -e "\n# Code Statistics\n\n" >> README.md
        - echo -e "# Code Statistics\n\n" > README_doc.md
        - sh site/radon.sh > radon.md
        - cat radon.md >> README.md
        - cat radon.md >> README_doc.md
        - echo -e "\n# Pylint\n\n" >> README.md
        - echo -e "\n# Pylint\n\n" >> README_doc.md
        - cat pylint.md >> README.md
        - cat pylint_doc.md >> README_doc.md
        - doxygen site/configuration.doxyfile
        - cp optom-imports.png docs/sources
        - rm -Rf optom
        - rm -Rf tests
        - rm -Rf site
        - rm run.py
        - rm README_doc.md
        - git add --all .
        - git commit -m "CircleCI run complete. Report https://github.com/masc/optom/blob/gh-pages/README.md , Doku http://masc.github.io/optom/docs/sources/index.html"
        - git push origin gh-pages
